<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CoreAuth | Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container dashboard-wide">
        <div class="tech-flow">
            <div class="badge-pill">FRONTEND: HTML/CSS/JS</div>
            <span class="arrow">→</span>
            <div class="badge-pill">BACKEND: NODE/EXPRESS</div>
            <span class="arrow">→</span>
            <div class="badge-pill">DATABASE: MONGODB</div>
        </div>

        <header style="margin-bottom: 40px; text-align: center;">
            <h1 style="font-size: 48px; font-weight: 800; color: #1e293b;">
                Welcome, <span id="welcomeName" style="color: #6366f1;">User</span>
            </h1>
            <p style="color: #64748b; font-size: 18px; margin-top: 10px;">
                System status: <span style="color: #10b981; font-weight: bold;">● Live Connection</span>
            </p>
        </header>

        <section class="info-grid">
            <div class="info-card"><h3>Frontend</h3><p>Captures user input and sends asynchronous <b>Fetch API</b> requests to the server.</p></div>
            <div class="info-card"><h3>Backend</h3><p>Processes logic via <b>Express Routes</b> and interacts with the database models.</p></div>
            <div class="info-card"><h3>Database</h3><p>Persistent storage using <b>MongoDB</b>. Data is retrieved as JSON objects.</p></div>
        </section>

        <h2 style="margin-top: 40px; color: #1e293b;">User Directory</h2>
        <p style="color: #64748b; margin-bottom: 20px;">Direct query from db.users.find()</p>

        <section class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>NAME</th>
                        <th>EMAIL</th>
                        <th>PHONE</th>
                        <th>ROLE</th>
                        <th>AGE</th>
                    </tr>
                </thead>
                <tbody id="userList"></tbody>
            </table>
        </section>

        <button onclick="logout()" class="logout-btn" style="margin-top: 30px; background:transparent; border:1px solid #ef4444; color:#ef4444; width:auto; padding:10px 30px; border-radius: 8px; cursor: pointer;">Logout</button>
    </div>

    <script>
        // 1. THIS RUNS AS SOON AS PAGE LOADS
        document.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('user_name');
            if (savedName) {
                // Sets the name from Login to the header
                document.getElementById('welcomeName').textContent = savedName.toLowerCase();
            } else {
                // If no name found, send back to login
                window.location.href = 'index.html';
            }
            loadUsers();
        });

        // 2. FETCH ALL USERS FOR THE TABLE
        async function loadUsers() {
            try {
                const res = await fetch('/api/auth/all-users');
                const users = await res.json();
                
                document.getElementById('userList').innerHTML = users.map(u => `
                    <tr>
                        <td style="font-weight: 700; color: #1e293b;">${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || 'undefined'}</td>
                        <td>${u.role || 'undefined'}</td>
                        <td>${u.age || 'undefined'}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error("Error loading users:", err);
            }
        }

        function logout() { 
            localStorage.clear(); 
            window.location.href = 'index.html'; 
        }
    </script>
</body>
</html>